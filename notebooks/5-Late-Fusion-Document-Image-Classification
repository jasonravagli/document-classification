{"nbformat":4,"nbformat_minor":0,"metadata":{"colab":{"name":"5-Late-Fusion-Document-Image-Classification","provenance":[],"collapsed_sections":["NLjSxjkBa9IF"],"toc_visible":true},"kernelspec":{"name":"python3","display_name":"Python 3"},"accelerator":"GPU","widgets":{"application/vnd.jupyter.widget-state+json":{"94ad0b3df5b94ac8942ff01e66d14656":{"model_module":"@jupyter-widgets/controls","model_name":"HBoxModel","state":{"_view_name":"HBoxView","_dom_classes":[],"_model_name":"HBoxModel","_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.5.0","box_style":"","layout":"IPY_MODEL_e0059157caa34bc297b12f63ed176ad4","_model_module":"@jupyter-widgets/controls","children":["IPY_MODEL_31a6bcd5b0df4f71bb385425c1b97113","IPY_MODEL_459ca4daef7b45cd965a9c4633ff2ba7"]}},"e0059157caa34bc297b12f63ed176ad4":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"31a6bcd5b0df4f71bb385425c1b97113":{"model_module":"@jupyter-widgets/controls","model_name":"FloatProgressModel","state":{"_view_name":"ProgressView","style":"IPY_MODEL_d85f0429c11748c29a5ae7840739e61f","_dom_classes":[],"description":"100%","_model_name":"FloatProgressModel","bar_style":"success","max":553507836,"_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","value":553507836,"_view_count":null,"_view_module_version":"1.5.0","orientation":"horizontal","min":0,"description_tooltip":null,"_model_module":"@jupyter-widgets/controls","layout":"IPY_MODEL_87b53844ac4a47ad9fc9e3714bf08867"}},"459ca4daef7b45cd965a9c4633ff2ba7":{"model_module":"@jupyter-widgets/controls","model_name":"HTMLModel","state":{"_view_name":"HTMLView","style":"IPY_MODEL_4f9cdac5ed0d406684d6d8c3bf072c08","_dom_classes":[],"description":"","_model_name":"HTMLModel","placeholder":"​","_view_module":"@jupyter-widgets/controls","_model_module_version":"1.5.0","value":" 528M/528M [00:06&lt;00:00, 85.5MB/s]","_view_count":null,"_view_module_version":"1.5.0","description_tooltip":null,"_model_module":"@jupyter-widgets/controls","layout":"IPY_MODEL_cd718187a633412f9ca606a2bd1c5d74"}},"d85f0429c11748c29a5ae7840739e61f":{"model_module":"@jupyter-widgets/controls","model_name":"ProgressStyleModel","state":{"_view_name":"StyleView","_model_name":"ProgressStyleModel","description_width":"initial","_view_module":"@jupyter-widgets/base","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.2.0","bar_color":null,"_model_module":"@jupyter-widgets/controls"}},"87b53844ac4a47ad9fc9e3714bf08867":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}},"4f9cdac5ed0d406684d6d8c3bf072c08":{"model_module":"@jupyter-widgets/controls","model_name":"DescriptionStyleModel","state":{"_view_name":"StyleView","_model_name":"DescriptionStyleModel","description_width":"","_view_module":"@jupyter-widgets/base","_model_module_version":"1.5.0","_view_count":null,"_view_module_version":"1.2.0","_model_module":"@jupyter-widgets/controls"}},"cd718187a633412f9ca606a2bd1c5d74":{"model_module":"@jupyter-widgets/base","model_name":"LayoutModel","state":{"_view_name":"LayoutView","grid_template_rows":null,"right":null,"justify_content":null,"_view_module":"@jupyter-widgets/base","overflow":null,"_model_module_version":"1.2.0","_view_count":null,"flex_flow":null,"width":null,"min_width":null,"border":null,"align_items":null,"bottom":null,"_model_module":"@jupyter-widgets/base","top":null,"grid_column":null,"overflow_y":null,"overflow_x":null,"grid_auto_flow":null,"grid_area":null,"grid_template_columns":null,"flex":null,"_model_name":"LayoutModel","justify_items":null,"grid_row":null,"max_height":null,"align_content":null,"visibility":null,"align_self":null,"height":null,"min_height":null,"padding":null,"grid_auto_rows":null,"grid_gap":null,"max_width":null,"order":null,"_view_module_version":"1.2.0","grid_template_areas":null,"object_position":null,"object_fit":null,"grid_auto_columns":null,"margin":null,"display":null,"left":null}}}}},"cells":[{"cell_type":"markdown","metadata":{"id":"u-pfXw83ZF9V","colab_type":"text"},"source":["# Setup\n","\n","\n","> Import libraries\n","\n","> Import Drive\n","\n","\n"]},{"cell_type":"code","metadata":{"id":"755J3fS5Y7Ec","colab_type":"code","outputId":"63d55c31-56a4-4609-da9a-c79ac1cd6c90","executionInfo":{"status":"ok","timestamp":1592158080697,"user_tz":-120,"elapsed":146449,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":346}},"source":["!pip install \"torch==1.4\" \"torchvision==0.5.0\""],"execution_count":0,"outputs":[{"output_type":"stream","text":["Collecting torch==1.4\n","\u001b[?25l  Downloading https://files.pythonhosted.org/packages/24/19/4804aea17cd136f1705a5e98a00618cb8f6ccc375ad8bfa437408e09d058/torch-1.4.0-cp36-cp36m-manylinux1_x86_64.whl (753.4MB)\n","\u001b[K     |████████████████████████████████| 753.4MB 21kB/s \n","\u001b[?25hCollecting torchvision==0.5.0\n","\u001b[?25l  Downloading https://files.pythonhosted.org/packages/7e/90/6141bf41f5655c78e24f40f710fdd4f8a8aff6c8b7c6f0328240f649bdbe/torchvision-0.5.0-cp36-cp36m-manylinux1_x86_64.whl (4.0MB)\n","\u001b[K     |████████████████████████████████| 4.0MB 35.7MB/s \n","\u001b[?25hRequirement already satisfied: pillow>=4.1.1 in /usr/local/lib/python3.6/dist-packages (from torchvision==0.5.0) (7.0.0)\n","Requirement already satisfied: numpy in /usr/local/lib/python3.6/dist-packages (from torchvision==0.5.0) (1.18.5)\n","Requirement already satisfied: six in /usr/local/lib/python3.6/dist-packages (from torchvision==0.5.0) (1.12.0)\n","Installing collected packages: torch, torchvision\n","  Found existing installation: torch 1.5.0+cu101\n","    Uninstalling torch-1.5.0+cu101:\n","      Successfully uninstalled torch-1.5.0+cu101\n","  Found existing installation: torchvision 0.6.0+cu101\n","    Uninstalling torchvision-0.6.0+cu101:\n","      Successfully uninstalled torchvision-0.6.0+cu101\n","Successfully installed torch-1.4.0 torchvision-0.5.0\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"57Y7UvGDZc-q","colab_type":"code","colab":{}},"source":["import pandas as pd\n","import numpy as np\n","import io\n","import os\n","\n","from tqdm import tqdm\n","\n","import fastai\n","from fastai import *\n","from fastai.text import * \n","from functools import partial\n","from fastai.vision import *\n","from fastai.metrics import error_rate\n","\n","import h5py\n","import numpy as np\n","import pandas as pd\n","import cv2\n","from tqdm import tqdm\n","from fastai.callbacks import EarlyStoppingCallback, SaveModelCallback\n","from fastai.metrics import error_rate\n","\n","# Google Drive\n","from pydrive.auth import GoogleAuth\n","from pydrive.drive import GoogleDrive\n","from google.colab import auth, drive\n","from oauth2client.client import GoogleCredentials\n","from google.colab import drive"],"execution_count":0,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"8f_eNXQgZf6S","colab_type":"text"},"source":["Google Drive"]},{"cell_type":"code","metadata":{"id":"5U4qYrxteh7r","colab_type":"code","outputId":"ae5e75eb-64e6-4a9a-b409-406cb4233e91","executionInfo":{"status":"ok","timestamp":1592158122222,"user_tz":-120,"elapsed":187914,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":128}},"source":["# auth.authenticate_user()\n","# gauth = GoogleAuth()\n","# gauth.credentials = GoogleCredentials.get_application_default()\n","# GoogleDrive(gauth)\n","drive.mount(\"/content/drive\")"],"execution_count":0,"outputs":[{"output_type":"stream","text":["Go to this URL in a browser: https://accounts.google.com/o/oauth2/auth?client_id=947318989803-6bn6qk8qdgf4n4g3pfee6491hc0brc4i.apps.googleusercontent.com&redirect_uri=urn%3aietf%3awg%3aoauth%3a2.0%3aoob&response_type=code&scope=email%20https%3a%2f%2fwww.googleapis.com%2fauth%2fdocs.test%20https%3a%2f%2fwww.googleapis.com%2fauth%2fdrive%20https%3a%2f%2fwww.googleapis.com%2fauth%2fdrive.photos.readonly%20https%3a%2f%2fwww.googleapis.com%2fauth%2fpeopleapi.readonly\n","\n","Enter your authorization code:\n","··········\n","Mounted at /content/drive\n"],"name":"stdout"}]},{"cell_type":"markdown","metadata":{"id":"qJRSsk-iZmcF","colab_type":"text"},"source":["General parameters and settings"]},{"cell_type":"code","metadata":{"id":"G3JEBf1fZn9R","colab_type":"code","colab":{}},"source":["input_models_folder = \"/content/drive/My Drive/document-classification/models/final-models/\"\n","output_models_folder = \"/content/drive/My Drive/document-classification/models/output-late-fusion\"\n","dataset_path = \"/content/drive/My Drive/document-classification/datasets/rvl-cdip/mini-dataset-1488-288-192\"\n","\n","path_train_ocr = os.path.join(dataset_path, 'train_extracted.csv')\n","path_test_ocr = os.path.join(dataset_path, 'test_extracted.csv')\n","path_valid_ocr = os.path.join(dataset_path, 'valid_extracted.csv')\n","\n","# Shape of the images in input to the CNN\n","cnn_image_shape = (224, 224)\n","# Number of images classes\n","n_classes = 16\n","# Batch size to be used in training\n","batch_size = 32"],"execution_count":0,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"5Rc3YUhvaOr1","colab_type":"text"},"source":["# Input Models"]},{"cell_type":"markdown","metadata":{"id":"BDTHjQ6Sh0E3","colab_type":"text"},"source":["Load the VGG model (image classification) and the LSTM based model (text classification) trained in the previous notebooks."]},{"cell_type":"markdown","metadata":{"id":"hoEMGzlfaui0","colab_type":"text"},"source":["## VGG Model"]},{"cell_type":"markdown","metadata":{"id":"VARXe8_0bJGj","colab_type":"text"},"source":["### Data"]},{"cell_type":"code","metadata":{"id":"p-fxMdzpDdgF","colab_type":"code","outputId":"25d705ca-bae9-4a6f-bb63-06d8abca52d1","executionInfo":{"status":"ok","timestamp":1592158231440,"user_tz":-120,"elapsed":109169,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":235}},"source":["df_train = pd.read_csv(os.path.join(dataset_path, \"train-labels.csv\"), names=[\"image\", \"label\"])\n","df_valid = pd.read_csv(os.path.join(dataset_path, \"valid-labels.csv\"), names=[\"image\", \"label\"])\n","df_train[\"is_valid\"] = False\n","df_valid[\"is_valid\"] = True\n","df_joined = pd.concat([df_train, df_valid], ignore_index=True)\n","print(df_joined.head())\n","print(df_joined.tail())\n","\n","data_vgg = (ImageList.from_df(df_joined, dataset_path, cols=\"image\")#, folder=mini_dataset_path)\n","        .split_from_df()\n","        .label_from_df()\n","        .transform(size=cnn_image_shape, resize_method=ResizeMethod.SQUISH)\n","        .databunch(bs=batch_size)\n","        .normalize())"],"execution_count":0,"outputs":[{"output_type":"stream","text":["                                 image  label  is_valid\n","0  train/0/0/0/0/94002065_94002066.tif     10     False\n","1         train/0/0/0/1/2074950097.tif     10     False\n","2      train/0/0/0/2/50284095-4103.tif      6     False\n","3           train/0/0/0/3/04003306.tif     10     False\n","4         train/0/0/0/4/2024967978.tif     11     False\n","                                        image  label  is_valid\n","1771             valid/0/2/8/3/0060077830.tif      7      True\n","1772             valid/0/2/8/4/2045723775.tif     15      True\n","1773  valid/0/2/8/5/2062426213_2062426237.tif     12      True\n","1774      valid/0/2/8/6/01747683_01747694.tif     13      True\n","1775               valid/0/2/8/7/10395005.tif      8      True\n"],"name":"stdout"}]},{"cell_type":"markdown","metadata":{"id":"KVjv7tE5bK28","colab_type":"text"},"source":["### Model"]},{"cell_type":"code","metadata":{"id":"Y3pUjgmoduN1","colab_type":"code","outputId":"e62e2b47-08ef-402b-9fb3-fa8e40d59b3e","executionInfo":{"status":"ok","timestamp":1592158240825,"user_tz":-120,"elapsed":112621,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":1000,"referenced_widgets":["94ad0b3df5b94ac8942ff01e66d14656","e0059157caa34bc297b12f63ed176ad4","31a6bcd5b0df4f71bb385425c1b97113","459ca4daef7b45cd965a9c4633ff2ba7","d85f0429c11748c29a5ae7840739e61f","87b53844ac4a47ad9fc9e3714bf08867","4f9cdac5ed0d406684d6d8c3bf072c08","cd718187a633412f9ca606a2bd1c5d74"]}},"source":["learn_vgg = cnn_learner(data_vgg, models.vgg16_bn, metrics=accuracy,\n","                    model_dir=input_models_folder)\n","learn_vgg.load(\"image-class_1488-288-192_valid-acc-67.36\");\n","learn_vgg.model"],"execution_count":0,"outputs":[{"output_type":"stream","text":["Downloading: \"https://download.pytorch.org/models/vgg16_bn-6c64b313.pth\" to /root/.cache/torch/checkpoints/vgg16_bn-6c64b313.pth\n"],"name":"stderr"},{"output_type":"display_data","data":{"application/vnd.jupyter.widget-view+json":{"model_id":"94ad0b3df5b94ac8942ff01e66d14656","version_minor":0,"version_major":2},"text/plain":["HBox(children=(FloatProgress(value=0.0, max=553507836.0), HTML(value='')))"]},"metadata":{"tags":[]}},{"output_type":"stream","text":["\n"],"name":"stdout"},{"output_type":"execute_result","data":{"text/plain":["Sequential(\n","  (0): Sequential(\n","    (0): Sequential(\n","      (0): Conv2d(3, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (2): ReLU(inplace=True)\n","      (3): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (4): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (5): ReLU(inplace=True)\n","      (6): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","      (7): Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (8): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (9): ReLU(inplace=True)\n","      (10): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (11): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (12): ReLU(inplace=True)\n","      (13): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","      (14): Conv2d(128, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (15): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (16): ReLU(inplace=True)\n","      (17): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (18): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (19): ReLU(inplace=True)\n","      (20): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (21): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (22): ReLU(inplace=True)\n","      (23): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","      (24): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (25): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (26): ReLU(inplace=True)\n","      (27): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (28): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (29): ReLU(inplace=True)\n","      (30): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (31): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (32): ReLU(inplace=True)\n","      (33): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","      (34): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (35): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (36): ReLU(inplace=True)\n","      (37): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (38): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (39): ReLU(inplace=True)\n","      (40): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (41): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (42): ReLU(inplace=True)\n","      (43): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","    )\n","    (1): AdaptiveAvgPool2d(output_size=(7, 7))\n","  )\n","  (1): Sequential(\n","    (0): AdaptiveConcatPool2d(\n","      (ap): AdaptiveAvgPool2d(output_size=1)\n","      (mp): AdaptiveMaxPool2d(output_size=1)\n","    )\n","    (1): Flatten()\n","    (2): BatchNorm1d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","    (3): Dropout(p=0.25, inplace=False)\n","    (4): Linear(in_features=1024, out_features=512, bias=True)\n","    (5): ReLU(inplace=True)\n","    (6): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","    (7): Dropout(p=0.5, inplace=False)\n","    (8): Linear(in_features=512, out_features=16, bias=True)\n","  )\n",")"]},"metadata":{"tags":[]},"execution_count":6}]},{"cell_type":"markdown","metadata":{"id":"wQ5eTjJwgxnH","colab_type":"text"},"source":["Remove the final layers from the model: ***NOT HERE IN THIS FUSION***"]},{"cell_type":"code","metadata":{"id":"iwO-kpzmeQmd","colab_type":"code","colab":{}},"source":["#learn_vgg.model[-1] = learn_vgg.model[-1][:-3] \n","#learn_vgg.model"],"execution_count":0,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"NLjSxjkBa9IF","colab_type":"text"},"source":["## LSTM-based Model (ULMFiT)"]},{"cell_type":"markdown","metadata":{"id":"h7Hj0jKAazs7","colab_type":"text"},"source":["### Data"]},{"cell_type":"code","metadata":{"id":"5XZ0KIAjedn8","colab_type":"code","outputId":"ae370905-607b-48fa-cd1b-8c9569c6338b","executionInfo":{"status":"ok","timestamp":1592158243434,"user_tz":-120,"elapsed":110643,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":35}},"source":["df_trn, df_val, df_test = pd.read_csv(path_train_ocr,names=['text','label']), pd.read_csv(path_valid_ocr,names=['text','label']), pd.read_csv(path_test_ocr,names=['text','label'])\n","print(df_trn.shape, df_val.shape, df_test.shape)"],"execution_count":0,"outputs":[{"output_type":"stream","text":["(1488, 2) (288, 2) (192, 2)\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"_XSuZDp1exH0","colab_type":"code","outputId":"8ebed067-3fcd-48d9-c308-a0d15309a40b","executionInfo":{"status":"ok","timestamp":1592158255301,"user_tz":-120,"elapsed":121457,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":17}},"source":["# Language model data\n","data_lm = TextLMDataBunch.from_df(train_df = df_trn, valid_df = df_val, path = \"\",\n","                                  text_cols=\"text\", label_cols=\"label\")\n","# Classifier model data\n","data_clas = TextClasDataBunch.from_df(path = \"\", train_df = df_trn, valid_df = df_val,\n","                                      text_cols=\"text\", label_cols=\"label\", vocab=data_lm.train_ds.vocab, bs=batch_size)"],"execution_count":0,"outputs":[{"output_type":"display_data","data":{"text/html":[""],"text/plain":["<IPython.core.display.HTML object>"]},"metadata":{"tags":[]}},{"output_type":"display_data","data":{"text/html":[""],"text/plain":["<IPython.core.display.HTML object>"]},"metadata":{"tags":[]}},{"output_type":"display_data","data":{"text/html":[""],"text/plain":["<IPython.core.display.HTML object>"]},"metadata":{"tags":[]}},{"output_type":"display_data","data":{"text/html":[""],"text/plain":["<IPython.core.display.HTML object>"]},"metadata":{"tags":[]}}]},{"cell_type":"markdown","metadata":{"id":"38p0TVX0a1tE","colab_type":"text"},"source":["### Model"]},{"cell_type":"code","metadata":{"id":"zQ5Sbfr4e4VU","colab_type":"code","outputId":"0253ba21-d106-4089-ce25-8730f6367e3a","executionInfo":{"status":"ok","timestamp":1592158269322,"user_tz":-120,"elapsed":133450,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":726}},"source":["learn_text = text_classifier_learner(data_clas, arch=AWD_LSTM, drop_mult=0.7,\n","                                     model_dir=input_models_folder)\n","learn_text.load(\"text-class_1488-288-192_valid-acc-59.38\")\n","learn_text.model"],"execution_count":0,"outputs":[{"output_type":"stream","text":["Downloading https://s3.amazonaws.com/fast-ai-modelzoo/wt103-fwd.tgz\n"],"name":"stdout"},{"output_type":"display_data","data":{"text/html":[""],"text/plain":["<IPython.core.display.HTML object>"]},"metadata":{"tags":[]}},{"output_type":"execute_result","data":{"text/plain":["SequentialRNN(\n","  (0): MultiBatchEncoder(\n","    (module): AWD_LSTM(\n","      (encoder): Embedding(15392, 400, padding_idx=1)\n","      (encoder_dp): EmbeddingDropout(\n","        (emb): Embedding(15392, 400, padding_idx=1)\n","      )\n","      (rnns): ModuleList(\n","        (0): WeightDropout(\n","          (module): LSTM(400, 1152, batch_first=True)\n","        )\n","        (1): WeightDropout(\n","          (module): LSTM(1152, 1152, batch_first=True)\n","        )\n","        (2): WeightDropout(\n","          (module): LSTM(1152, 400, batch_first=True)\n","        )\n","      )\n","      (input_dp): RNNDropout()\n","      (hidden_dps): ModuleList(\n","        (0): RNNDropout()\n","        (1): RNNDropout()\n","        (2): RNNDropout()\n","      )\n","    )\n","  )\n","  (1): PoolingLinearClassifier(\n","    (layers): Sequential(\n","      (0): BatchNorm1d(1200, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (1): Dropout(p=0.27999999999999997, inplace=False)\n","      (2): Linear(in_features=1200, out_features=50, bias=True)\n","      (3): ReLU(inplace=True)\n","      (4): BatchNorm1d(50, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (5): Dropout(p=0.1, inplace=False)\n","      (6): Linear(in_features=50, out_features=16, bias=True)\n","    )\n","  )\n",")"]},"metadata":{"tags":[]},"execution_count":9}]},{"cell_type":"markdown","metadata":{"id":"BpjHs2xFhBMA","colab_type":"text"},"source":["***NOT HERE IN THIS FUSION***\n","Remove the final layers from the model (according to https://gist.github.com/joshfp/b62b76eae95e6863cb511997b5a63118)"]},{"cell_type":"code","metadata":{"id":"f_ddKCxZfNzF","colab_type":"code","colab":{}},"source":["#learn_text.model[-1].layers = learn_text.model[-1].layers[:-3] \n","#learn_text.model"],"execution_count":0,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"OAYEuveEfclc","colab_type":"text"},"source":["# Concatenated Model"]},{"cell_type":"markdown","metadata":{"id":"q5hfaaxvidMI","colab_type":"text"},"source":["Combine the two previous models into a new one. Doing this, the new model will classify using both visual and textual features."]},{"cell_type":"markdown","metadata":{"id":"aH7fKnHSnLiR","colab_type":"text"},"source":["## Data"]},{"cell_type":"markdown","metadata":{"id":"sBoo3jY5blEO","colab_type":"text"},"source":["Define a custom PyTorch Dataset to concat the two datasets (images and text).\n","\n","When an element of the Dataset is requested (\\_\\_getitem\\__ method) resize the corresponding image to the target size before returning it along with the text and the label.\n","\n","N.B.: passing an ImageList could not be memory efficient (check how fastai manage the images in ImageList). Consider passing a list of paths and loading the image in \\_\\_getItem\\_\\_"]},{"cell_type":"code","metadata":{"id":"dTtMBAWXff4k","colab_type":"code","colab":{}},"source":["# Per accedere ad alcune funzionalità di fastai è necessario definire cose aggiuntive\n","# nel Dataset\n","class ConcatDataset(Dataset):\n","    def __init__(self, x_images: ImageList, x_texts: TextList, y): \n","        self.x_images = x_images\n","        self.x_texts = x_texts\n","        self.y = y\n","\n","    def __len__(self):\n","        return len(self.y)\n","    \n","    def __getitem__(self, i):\n","        return (self.x_images[i].apply_tfms([], size=cnn_image_shape, resize_method=ResizeMethod.SQUISH),\n","                                      self.x_texts[i]), self.y[i]\n","\n","train_ds = ConcatDataset(data_vgg.train_ds.x, data_clas.train_ds.x, data_vgg.train_ds.y)\n","valid_ds = ConcatDataset(data_vgg.valid_ds.x, data_clas.valid_ds.x, data_vgg.valid_ds.y)"],"execution_count":0,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"AqZH5ERoe1XH","colab_type":"text"},"source":["Define a collate function to pass to the DataBunch. This function will replace the one used by the Dataloader and describe how to collate the samples taken for a batch from the ConcatDataset."]},{"cell_type":"code","metadata":{"id":"xLv_ovjGfKhm","colab_type":"code","colab":{}},"source":["def my_collate(batch):\n","    x,y = list(zip(*batch))\n","    x1,x2 = list(zip(*x))\n","    x1 = to_data(x1)\n","    x1 = torch.stack(x1)\n","    x2, y = pad_collate(list(zip(x2, y)), pad_idx=1, pad_first=True)\n","    \n","    return (x1, x2), y"],"execution_count":0,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"oDXAXxZxfgc6","colab_type":"text"},"source":["The following two cells were used in the example taken from https://gist.github.com/joshfp/b62b76eae95e6863cb511997b5a63118.\n","\n","The Sampler would allow to random sort data, but their behaviour is not clear to us.\n","We found simpler letting the DataBunch automatic creating the DataLoaders."]},{"cell_type":"markdown","metadata":{"id":"Y5soXFj4gkCY","colab_type":"text"},"source":["Create the DataBunch from the custom datasets and the collate function."]},{"cell_type":"code","metadata":{"id":"6cVrPn38gsxX","colab_type":"code","colab":{}},"source":["data = DataBunch.create(train_ds, valid_ds, collate_fn=my_collate, path=dataset_path, bs=batch_size)"],"execution_count":0,"outputs":[]},{"cell_type":"code","metadata":{"id":"0bCaaM7I1oFm","colab_type":"code","colab":{}},"source":["data.one_batch()"],"execution_count":0,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"og60OiHIpPky","colab_type":"text"},"source":["## Model"]},{"cell_type":"markdown","metadata":{"id":"SuL4I1p-l1y7","colab_type":"text"},"source":["Define the new model taking the other two and adding linear layers at the end.\n","\n","The size of the input to the first linear layer must agree with the output of the other two models.\n","\n","We add two blocks of batch normalization + dropout + linear layers.\n","\n","Dropout probability suggested values are 0.25 for the dropout between the input layer and the linear layer before softmax, and 0.5 for the dropout before softmax layer. In this case, the input size to the first linear layer is only 32 (16 probabilities from the text classifier + 16 probabilities from the image classifier) so set dropout probability to 0."]},{"cell_type":"code","metadata":{"id":"VD76UX5UpaEj","colab_type":"code","outputId":"a10fad01-4a8d-4041-c23c-0727b9506262","executionInfo":{"status":"ok","timestamp":1592158308740,"user_tz":-120,"elapsed":162190,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":1000}},"source":["learn_vgg.summary()"],"execution_count":0,"outputs":[{"output_type":"execute_result","data":{"text/plain":["Sequential\n","======================================================================\n","Layer (type)         Output Shape         Param #    Trainable \n","======================================================================\n","Conv2d               [64, 224, 224]       1,792      False     \n","______________________________________________________________________\n","BatchNorm2d          [64, 224, 224]       128        True      \n","______________________________________________________________________\n","ReLU                 [64, 224, 224]       0          False     \n","______________________________________________________________________\n","Conv2d               [64, 224, 224]       36,928     False     \n","______________________________________________________________________\n","BatchNorm2d          [64, 224, 224]       128        True      \n","______________________________________________________________________\n","ReLU                 [64, 224, 224]       0          False     \n","______________________________________________________________________\n","MaxPool2d            [64, 112, 112]       0          False     \n","______________________________________________________________________\n","Conv2d               [128, 112, 112]      73,856     False     \n","______________________________________________________________________\n","BatchNorm2d          [128, 112, 112]      256        True      \n","______________________________________________________________________\n","ReLU                 [128, 112, 112]      0          False     \n","______________________________________________________________________\n","Conv2d               [128, 112, 112]      147,584    False     \n","______________________________________________________________________\n","BatchNorm2d          [128, 112, 112]      256        True      \n","______________________________________________________________________\n","ReLU                 [128, 112, 112]      0          False     \n","______________________________________________________________________\n","MaxPool2d            [128, 56, 56]        0          False     \n","______________________________________________________________________\n","Conv2d               [256, 56, 56]        295,168    False     \n","______________________________________________________________________\n","BatchNorm2d          [256, 56, 56]        512        True      \n","______________________________________________________________________\n","ReLU                 [256, 56, 56]        0          False     \n","______________________________________________________________________\n","Conv2d               [256, 56, 56]        590,080    False     \n","______________________________________________________________________\n","BatchNorm2d          [256, 56, 56]        512        True      \n","______________________________________________________________________\n","ReLU                 [256, 56, 56]        0          False     \n","______________________________________________________________________\n","Conv2d               [256, 56, 56]        590,080    False     \n","______________________________________________________________________\n","BatchNorm2d          [256, 56, 56]        512        True      \n","______________________________________________________________________\n","ReLU                 [256, 56, 56]        0          False     \n","______________________________________________________________________\n","MaxPool2d            [256, 28, 28]        0          False     \n","______________________________________________________________________\n","Conv2d               [512, 28, 28]        1,180,160  False     \n","______________________________________________________________________\n","BatchNorm2d          [512, 28, 28]        1,024      True      \n","______________________________________________________________________\n","ReLU                 [512, 28, 28]        0          False     \n","______________________________________________________________________\n","Conv2d               [512, 28, 28]        2,359,808  False     \n","______________________________________________________________________\n","BatchNorm2d          [512, 28, 28]        1,024      True      \n","______________________________________________________________________\n","ReLU                 [512, 28, 28]        0          False     \n","______________________________________________________________________\n","Conv2d               [512, 28, 28]        2,359,808  False     \n","______________________________________________________________________\n","BatchNorm2d          [512, 28, 28]        1,024      True      \n","______________________________________________________________________\n","ReLU                 [512, 28, 28]        0          False     \n","______________________________________________________________________\n","MaxPool2d            [512, 14, 14]        0          False     \n","______________________________________________________________________\n","Conv2d               [512, 14, 14]        2,359,808  False     \n","______________________________________________________________________\n","BatchNorm2d          [512, 14, 14]        1,024      True      \n","______________________________________________________________________\n","ReLU                 [512, 14, 14]        0          False     \n","______________________________________________________________________\n","Conv2d               [512, 14, 14]        2,359,808  False     \n","______________________________________________________________________\n","BatchNorm2d          [512, 14, 14]        1,024      True      \n","______________________________________________________________________\n","ReLU                 [512, 14, 14]        0          False     \n","______________________________________________________________________\n","Conv2d               [512, 14, 14]        2,359,808  False     \n","______________________________________________________________________\n","BatchNorm2d          [512, 14, 14]        1,024      True      \n","______________________________________________________________________\n","ReLU                 [512, 14, 14]        0          False     \n","______________________________________________________________________\n","MaxPool2d            [512, 7, 7]          0          False     \n","______________________________________________________________________\n","AdaptiveAvgPool2d    [512, 7, 7]          0          False     \n","______________________________________________________________________\n","AdaptiveAvgPool2d    [512, 1, 1]          0          False     \n","______________________________________________________________________\n","AdaptiveMaxPool2d    [512, 1, 1]          0          False     \n","______________________________________________________________________\n","Flatten              [1024]               0          False     \n","______________________________________________________________________\n","BatchNorm1d          [1024]               2,048      True      \n","______________________________________________________________________\n","Dropout              [1024]               0          False     \n","______________________________________________________________________\n","Linear               [512]                524,800    True      \n","______________________________________________________________________\n","ReLU                 [512]                0          False     \n","______________________________________________________________________\n","BatchNorm1d          [512]                1,024      True      \n","______________________________________________________________________\n","Dropout              [512]                0          False     \n","______________________________________________________________________\n","Linear               [16]                 8,208      True      \n","______________________________________________________________________\n","\n","Total params: 15,259,216\n","Total trainable params: 544,528\n","Total non-trainable params: 14,714,688\n","Optimized with 'torch.optim.adam.Adam', betas=(0.9, 0.99)\n","Using true weight decay as discussed in https://www.fast.ai/2018/07/02/adam-weight-decay/ \n","Loss function : FlattenedLoss\n","======================================================================\n","Callbacks functions applied "]},"metadata":{"tags":[]},"execution_count":13}]},{"cell_type":"code","metadata":{"id":"BU8qHKqZpUN9","colab_type":"code","colab":{}},"source":["class ConcatModel(nn.Module):\n","    def __init__(self, mod_cnn, mod_nlp, input_dim, output_dim): \n","        super().__init__()\n","        self.mod_cnn = mod_cnn\n","        self.mod_nlp = mod_nlp\n","        \n","        # Final custom part\n","        n_neurons = 256\n","        last_layers = []\n","        last_layers += bn_drop_lin(input_dim, n_neurons, p=0, actn=nn.ReLU(inplace=True))\n","        last_layers += bn_drop_lin(n_neurons, output_dim, p=0.5)\n","        # lst_layers = []\n","        # activs = [nn.ReLU(inplace=True),] * (len(layers)-2) + [None]\n","        # for n_in,n_out,p,actn in zip(layers[:-1], layers[1:], drops, activs):\n","        #     lst_layers += bn_drop_lin(n_in, n_out, p=p, actn=actn)\n","        self.layers = nn.Sequential(*last_layers)\n","\n","    def forward(self, x_cnn, x_nlp):\n","        x_cnn = self.mod_cnn(x_cnn)\n","        # perchè [0]? Rimuovere? -> Forse perche il cat si aspetta la stessa \n","        # dimensione dei tensori lungo la dim=0 e x_nlp diventa multidim?\n","        x_nlp = self.mod_nlp(x_nlp)[0]\n","        x = torch.cat([x_cnn, x_nlp], dim=1)\n","        return self.layers(x)    "],"execution_count":0,"outputs":[]},{"cell_type":"code","metadata":{"id":"R4vp27FipbbE","colab_type":"code","outputId":"4a3da410-16e5-42cd-ae32-81df3922baa8","executionInfo":{"status":"ok","timestamp":1592158308744,"user_tz":-120,"elapsed":155872,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":1000}},"source":["input_dim = 32\n","output_dim = 16\n","model = ConcatModel(learn_vgg.model, learn_text.model, input_dim, output_dim)\n","model"],"execution_count":0,"outputs":[{"output_type":"execute_result","data":{"text/plain":["ConcatModel(\n","  (mod_cnn): Sequential(\n","    (0): Sequential(\n","      (0): Sequential(\n","        (0): Conv2d(3, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (2): ReLU(inplace=True)\n","        (3): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (4): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (5): ReLU(inplace=True)\n","        (6): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","        (7): Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (8): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (9): ReLU(inplace=True)\n","        (10): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (11): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (12): ReLU(inplace=True)\n","        (13): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","        (14): Conv2d(128, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (15): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (16): ReLU(inplace=True)\n","        (17): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (18): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (19): ReLU(inplace=True)\n","        (20): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (21): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (22): ReLU(inplace=True)\n","        (23): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","        (24): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (25): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (26): ReLU(inplace=True)\n","        (27): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (28): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (29): ReLU(inplace=True)\n","        (30): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (31): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (32): ReLU(inplace=True)\n","        (33): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","        (34): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (35): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (36): ReLU(inplace=True)\n","        (37): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (38): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (39): ReLU(inplace=True)\n","        (40): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","        (41): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (42): ReLU(inplace=True)\n","        (43): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","      )\n","      (1): AdaptiveAvgPool2d(output_size=(7, 7))\n","    )\n","    (1): Sequential(\n","      (0): AdaptiveConcatPool2d(\n","        (ap): AdaptiveAvgPool2d(output_size=1)\n","        (mp): AdaptiveMaxPool2d(output_size=1)\n","      )\n","      (1): Flatten()\n","      (2): BatchNorm1d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (3): Dropout(p=0.25, inplace=False)\n","      (4): Linear(in_features=1024, out_features=512, bias=True)\n","      (5): ReLU(inplace=True)\n","      (6): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (7): Dropout(p=0.5, inplace=False)\n","      (8): Linear(in_features=512, out_features=16, bias=True)\n","    )\n","  )\n","  (mod_nlp): SequentialRNN(\n","    (0): MultiBatchEncoder(\n","      (module): AWD_LSTM(\n","        (encoder): Embedding(15392, 400, padding_idx=1)\n","        (encoder_dp): EmbeddingDropout(\n","          (emb): Embedding(15392, 400, padding_idx=1)\n","        )\n","        (rnns): ModuleList(\n","          (0): WeightDropout(\n","            (module): LSTM(400, 1152, batch_first=True)\n","          )\n","          (1): WeightDropout(\n","            (module): LSTM(1152, 1152, batch_first=True)\n","          )\n","          (2): WeightDropout(\n","            (module): LSTM(1152, 400, batch_first=True)\n","          )\n","        )\n","        (input_dp): RNNDropout()\n","        (hidden_dps): ModuleList(\n","          (0): RNNDropout()\n","          (1): RNNDropout()\n","          (2): RNNDropout()\n","        )\n","      )\n","    )\n","    (1): PoolingLinearClassifier(\n","      (layers): Sequential(\n","        (0): BatchNorm1d(1200, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (1): Dropout(p=0.27999999999999997, inplace=False)\n","        (2): Linear(in_features=1200, out_features=50, bias=True)\n","        (3): ReLU(inplace=True)\n","        (4): BatchNorm1d(50, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","        (5): Dropout(p=0.1, inplace=False)\n","        (6): Linear(in_features=50, out_features=16, bias=True)\n","      )\n","    )\n","  )\n","  (layers): Sequential(\n","    (0): BatchNorm1d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","    (1): Linear(in_features=32, out_features=256, bias=True)\n","    (2): ReLU(inplace=True)\n","    (3): BatchNorm1d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","    (4): Dropout(p=0.5, inplace=False)\n","    (5): Linear(in_features=256, out_features=16, bias=True)\n","  )\n",")"]},"metadata":{"tags":[]},"execution_count":15}]},{"cell_type":"markdown","metadata":{"id":"ofNKNyU6qLm5","colab_type":"text"},"source":["## Learner"]},{"cell_type":"code","metadata":{"id":"EsO0RZXRnjOq","colab_type":"code","outputId":"0530cf68-e27b-44d1-8f20-f94d0a60a9c4","executionInfo":{"status":"ok","timestamp":1592158308745,"user_tz":-120,"elapsed":149672,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":54}},"source":["print(len(learn_text.layer_groups))\n","print(len(learn_vgg.layer_groups))"],"execution_count":0,"outputs":[{"output_type":"stream","text":["5\n","3\n"],"name":"stdout"}]},{"cell_type":"code","metadata":{"id":"VailNOCcZseh","colab_type":"code","outputId":"4c3b3514-0b32-4f3d-9592-941569c61959","executionInfo":{"status":"ok","timestamp":1592158308746,"user_tz":-120,"elapsed":148756,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":1000}},"source":["learn_vgg.model"],"execution_count":0,"outputs":[{"output_type":"execute_result","data":{"text/plain":["Sequential(\n","  (0): Sequential(\n","    (0): Sequential(\n","      (0): Conv2d(3, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (2): ReLU(inplace=True)\n","      (3): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (4): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (5): ReLU(inplace=True)\n","      (6): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","      (7): Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (8): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (9): ReLU(inplace=True)\n","      (10): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (11): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (12): ReLU(inplace=True)\n","      (13): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","      (14): Conv2d(128, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (15): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (16): ReLU(inplace=True)\n","      (17): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (18): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (19): ReLU(inplace=True)\n","      (20): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (21): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (22): ReLU(inplace=True)\n","      (23): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","      (24): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (25): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (26): ReLU(inplace=True)\n","      (27): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (28): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (29): ReLU(inplace=True)\n","      (30): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (31): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (32): ReLU(inplace=True)\n","      (33): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","      (34): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (35): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (36): ReLU(inplace=True)\n","      (37): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (38): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (39): ReLU(inplace=True)\n","      (40): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","      (41): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","      (42): ReLU(inplace=True)\n","      (43): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","    )\n","    (1): AdaptiveAvgPool2d(output_size=(7, 7))\n","  )\n","  (1): Sequential(\n","    (0): AdaptiveConcatPool2d(\n","      (ap): AdaptiveAvgPool2d(output_size=1)\n","      (mp): AdaptiveMaxPool2d(output_size=1)\n","    )\n","    (1): Flatten()\n","    (2): BatchNorm1d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","    (3): Dropout(p=0.25, inplace=False)\n","    (4): Linear(in_features=1024, out_features=512, bias=True)\n","    (5): ReLU(inplace=True)\n","    (6): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","    (7): Dropout(p=0.5, inplace=False)\n","    (8): Linear(in_features=512, out_features=16, bias=True)\n","  )\n",")"]},"metadata":{"tags":[]},"execution_count":17}]},{"cell_type":"code","metadata":{"id":"KHq3iYh0ZPq4","colab_type":"code","outputId":"1e4a157d-28b1-4613-a1e7-aa637d57bda4","executionInfo":{"status":"ok","timestamp":1592158308747,"user_tz":-120,"elapsed":146163,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":1000}},"source":["learn_vgg.layer_groups"],"execution_count":0,"outputs":[{"output_type":"execute_result","data":{"text/plain":["[Sequential(\n","   (0): Conv2d(3, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (2): ReLU(inplace=True)\n","   (3): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (4): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (5): ReLU(inplace=True)\n","   (6): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","   (7): Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (8): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (9): ReLU(inplace=True)\n","   (10): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (11): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (12): ReLU(inplace=True)\n","   (13): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","   (14): Conv2d(128, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (15): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (16): ReLU(inplace=True)\n","   (17): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (18): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (19): ReLU(inplace=True)\n","   (20): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (21): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n"," ), Sequential(\n","   (0): ReLU(inplace=True)\n","   (1): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","   (2): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (4): ReLU(inplace=True)\n","   (5): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (6): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (7): ReLU(inplace=True)\n","   (8): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (9): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (10): ReLU(inplace=True)\n","   (11): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","   (12): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (13): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (14): ReLU(inplace=True)\n","   (15): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (16): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (17): ReLU(inplace=True)\n","   (18): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))\n","   (19): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (20): ReLU(inplace=True)\n","   (21): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)\n","   (22): AdaptiveAvgPool2d(output_size=(7, 7))\n"," ), Sequential(\n","   (0): AdaptiveAvgPool2d(output_size=1)\n","   (1): AdaptiveMaxPool2d(output_size=1)\n","   (2): Flatten()\n","   (3): BatchNorm1d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (4): Dropout(p=0.25, inplace=False)\n","   (5): Linear(in_features=1024, out_features=512, bias=True)\n","   (6): ReLU(inplace=True)\n","   (7): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n","   (8): Dropout(p=0.5, inplace=False)\n","   (9): Linear(in_features=512, out_features=16, bias=True)\n"," )]"]},"metadata":{"tags":[]},"execution_count":18}]},{"cell_type":"markdown","metadata":{"id":"Ld4gb5R5c6bT","colab_type":"text"},"source":["Define layer groups for the new model. Reuse the two other models layer groups and add a group with the new final layers.\n","\n","N.B. Separate the CNN linear layers from the last convolutional section into a new group (Do it in the notebook 2)"]},{"cell_type":"code","metadata":{"id":"OhHhmmX9qRWl","colab_type":"code","colab":{}},"source":["loss_func = nn.CrossEntropyLoss()\n","# Serve per il discriminative layer training -> serve per dare learning rates diversi\n","# ad ogni gruppo\n","# Approfondire quali layer appartengono ai gruppi\n","layer_groups = [nn.Sequential(*flatten_model(learn_text.layer_groups[0])),\n","                nn.Sequential(*flatten_model(learn_text.layer_groups[1])),\n","                nn.Sequential(*(flatten_model(learn_text.layer_groups[2]) + \n","                                flatten_model(learn_vgg.layer_groups[0]))),\n","                nn.Sequential(*(flatten_model(learn_text.layer_groups[3]) + \n","                                flatten_model(learn_vgg.layer_groups[1]))),\n","                nn.Sequential(*(flatten_model(learn_text.layer_groups[4]) + \n","                                flatten_model(learn_vgg.layer_groups[2]))),\n","                nn.Sequential(*flatten_model(model.layers))]\n","\n","learn = Learner(data, model, loss_func=loss_func, metrics=accuracy, layer_groups=layer_groups,\n","                path=output_models_folder)"],"execution_count":0,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"tizW_P_AqQc9","colab_type":"text"},"source":["# Training"]},{"cell_type":"code","metadata":{"id":"vViMd6Q5o8Ir","colab_type":"code","colab":{}},"source":["# Congela tutti i gruppi di layer in layer_groups tranne nell'ultimo (i fully connected)\n","learn.freeze()\n","# learn.summary() -> non funziona per via del custom dataset"],"execution_count":0,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"XG5YUZUKnh4y","colab_type":"text"},"source":["Find the best learning rate studying its trend (Experimental).\n","\n","This function has been taken from this post: https://forums.fast.ai/t/automated-learning-rate-suggester/44199"]},{"cell_type":"code","metadata":{"id":"2SF2uu12nv2K","colab_type":"code","outputId":"86d8aaf5-e982-4bfc-95ab-93c20bb6f290","executionInfo":{"status":"ok","timestamp":1592120374849,"user_tz":-120,"elapsed":312312,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":688}},"source":["def find_appropriate_lr(model:Learner, lr_diff:int = 15, loss_threshold:float = .05, adjust_value:float = 1, plot:bool = False) -> float:\n","    #Run the Learning Rate Finder\n","    model.lr_find()\n","    \n","    #Get loss values and their corresponding gradients, and get lr values\n","    losses = np.array(model.recorder.losses)\n","    assert(lr_diff < len(losses))\n","    loss_grad = np.gradient(losses)\n","    lrs = model.recorder.lrs\n","    \n","    #Search for index in gradients where loss is lowest before the loss spike\n","    #Initialize right and left idx using the lr_diff as a spacing unit\n","    #Set the local min lr as -1 to signify if threshold is too low\n","    r_idx = -1\n","    l_idx = r_idx - lr_diff\n","    while (l_idx >= -len(losses)) and (abs(loss_grad[r_idx] - loss_grad[l_idx]) > loss_threshold):\n","        local_min_lr = lrs[l_idx]\n","        r_idx -= 1\n","        l_idx -= 1\n","\n","    lr_to_use = local_min_lr * adjust_value\n","    \n","    if plot:\n","        # plots the gradients of the losses in respect to the learning rate change\n","        plt.plot(loss_grad)\n","        plt.plot(len(losses)+l_idx, loss_grad[l_idx],markersize=10,marker='o',color='red')\n","        plt.ylabel(\"Loss\")\n","        plt.xlabel(\"Index of LRs\")\n","        plt.show()\n","\n","        plt.plot(np.log10(lrs), losses)\n","        plt.ylabel(\"Loss\")\n","        plt.xlabel(\"Log 10 Transform of Learning Rate\")\n","        loss_coord = np.interp(np.log10(lr_to_use), np.log10(lrs), losses)\n","        plt.plot(np.log10(lr_to_use), loss_coord, markersize=10,marker='o',color='red')\n","        plt.show()\n","        \n","    return lr_to_use\n","\n","learning_rate = find_appropriate_lr(learn, plot=True)\n","print(f\"Learning rate: {learning_rate}\")"],"execution_count":0,"outputs":[{"output_type":"display_data","data":{"text/html":["\n","    <div>\n","        <style>\n","            /* Turns off some styling */\n","            progress {\n","                /* gets rid of default border in Firefox and Opera. */\n","                border: none;\n","                /* Needs to be in here for Safari polyfill so background images work as expected. */\n","                background-size: auto;\n","            }\n","            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n","                background: #F44336;\n","            }\n","        </style>\n","      <progress value='1' class='' max='3' style='width:300px; height:20px; vertical-align: middle;'></progress>\n","      33.33% [1/3 03:59<07:59]\n","    </div>\n","    \n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: left;\">\n","      <th>epoch</th>\n","      <th>train_loss</th>\n","      <th>valid_loss</th>\n","      <th>accuracy</th>\n","      <th>time</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <td>0</td>\n","      <td>2.984515</td>\n","      <td>#na#</td>\n","      <td>03:59</td>\n","    </tr>\n","  </tbody>\n","</table><p>\n","\n","    <div>\n","        <style>\n","            /* Turns off some styling */\n","            progress {\n","                /* gets rid of default border in Firefox and Opera. */\n","                border: none;\n","                /* Needs to be in here for Safari polyfill so background images work as expected. */\n","                background-size: auto;\n","            }\n","            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {\n","                background: #F44336;\n","            }\n","        </style>\n","      <progress value='43' class='' max='46' style='width:300px; height:20px; vertical-align: middle;'></progress>\n","      93.48% [43/46 01:08<00:04 6.4235]\n","    </div>\n","    "],"text/plain":["<IPython.core.display.HTML object>"]},"metadata":{"tags":[]}},{"output_type":"stream","text":["LR Finder is complete, type {learner_name}.recorder.plot() to see the graph.\n"],"name":"stdout"},{"output_type":"display_data","data":{"image/png":"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\n","text/plain":["<Figure size 432x288 with 1 Axes>"]},"metadata":{"tags":[],"needs_background":"light"}},{"output_type":"display_data","data":{"image/png":"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\n","text/plain":["<Figure size 432x288 with 1 Axes>"]},"metadata":{"tags":[],"needs_background":"light"}},{"output_type":"stream","text":["Learning rate: 0.004365158322401656\n"],"name":"stdout"}]},{"cell_type":"markdown","metadata":{"id":"3f6yZ7PeGxxl","colab_type":"text"},"source":["Train the network."]},{"cell_type":"code","metadata":{"id":"421dYBJsHIMz","colab_type":"code","outputId":"1853ce9b-b33d-4c2b-f809-49bd7616d991","executionInfo":{"status":"ok","timestamp":1592127395736,"user_tz":-120,"elapsed":5406973,"user":{"displayName":"IACOPO ERPICHINI","photoUrl":"","userId":"15535855654116468778"}},"colab":{"base_uri":"https://localhost:8080/","height":1000}},"source":["save_model = SaveModelCallback(learn, every=\"improvement\", monitor=\"accuracy\",\n","                               mode=\"max\", name=\"best-late-fusion\")\n","learn.fit_one_cycle(80, max_lr=learning_rate, callbacks=[save_model])\n","print(\"Training completed\")"],"execution_count":0,"outputs":[{"output_type":"display_data","data":{"text/html":["<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: left;\">\n","      <th>epoch</th>\n","      <th>train_loss</th>\n","      <th>valid_loss</th>\n","      <th>accuracy</th>\n","      <th>time</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <td>0</td>\n","      <td>2.562870</td>\n","      <td>2.268186</td>\n","      <td>0.368056</td>\n","      <td>02:23</td>\n","    </tr>\n","    <tr>\n","      <td>1</td>\n","      <td>2.041801</td>\n","      <td>1.710591</td>\n","      <td>0.618056</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>2</td>\n","      <td>1.504132</td>\n","      <td>1.334311</td>\n","      <td>0.670139</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>3</td>\n","      <td>1.071713</td>\n","      <td>1.125241</td>\n","      <td>0.715278</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>4</td>\n","      <td>0.749341</td>\n","      <td>1.016885</td>\n","      <td>0.711806</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>5</td>\n","      <td>0.550182</td>\n","      <td>0.968455</td>\n","      <td>0.722222</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>6</td>\n","      <td>0.405874</td>\n","      <td>0.976125</td>\n","      <td>0.715278</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>7</td>\n","      <td>0.304332</td>\n","      <td>0.979401</td>\n","      <td>0.732639</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>8</td>\n","      <td>0.239205</td>\n","      <td>1.001340</td>\n","      <td>0.718750</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>9</td>\n","      <td>0.202554</td>\n","      <td>1.079045</td>\n","      <td>0.711806</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>10</td>\n","      <td>0.186607</td>\n","      <td>1.097999</td>\n","      <td>0.732639</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>11</td>\n","      <td>0.165217</td>\n","      <td>1.098294</td>\n","      <td>0.722222</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>12</td>\n","      <td>0.171408</td>\n","      <td>1.238211</td>\n","      <td>0.722222</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>13</td>\n","      <td>0.165493</td>\n","      <td>1.351731</td>\n","      <td>0.690972</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>14</td>\n","      <td>0.185946</td>\n","      <td>1.352672</td>\n","      <td>0.708333</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>15</td>\n","      <td>0.188680</td>\n","      <td>1.410130</td>\n","      <td>0.715278</td>\n","      <td>01:24</td>\n","    </tr>\n","    <tr>\n","      <td>16</td>\n","      <td>0.192978</td>\n","      <td>1.305492</td>\n","      <td>0.670139</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>17</td>\n","      <td>0.217511</td>\n","      <td>1.392905</td>\n","      <td>0.694444</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>18</td>\n","      <td>0.214599</td>\n","      <td>1.512945</td>\n","      <td>0.694444</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>19</td>\n","      <td>0.229288</td>\n","      <td>1.487781</td>\n","      <td>0.694444</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>20</td>\n","      <td>0.264129</td>\n","      <td>1.577127</td>\n","      <td>0.711806</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>21</td>\n","      <td>0.285301</td>\n","      <td>1.656583</td>\n","      <td>0.684028</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>22</td>\n","      <td>0.289860</td>\n","      <td>1.543073</td>\n","      <td>0.701389</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>23</td>\n","      <td>0.292056</td>\n","      <td>1.659883</td>\n","      <td>0.677083</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>24</td>\n","      <td>0.290861</td>\n","      <td>1.415698</td>\n","      <td>0.718750</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>25</td>\n","      <td>0.308150</td>\n","      <td>1.539612</td>\n","      <td>0.684028</td>\n","      <td>01:28</td>\n","    </tr>\n","    <tr>\n","      <td>26</td>\n","      <td>0.295950</td>\n","      <td>1.496045</td>\n","      <td>0.715278</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>27</td>\n","      <td>0.311082</td>\n","      <td>1.584713</td>\n","      <td>0.701389</td>\n","      <td>01:28</td>\n","    </tr>\n","    <tr>\n","      <td>28</td>\n","      <td>0.271255</td>\n","      <td>1.709373</td>\n","      <td>0.656250</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>29</td>\n","      <td>0.294887</td>\n","      <td>1.624480</td>\n","      <td>0.690972</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>30</td>\n","      <td>0.270135</td>\n","      <td>1.585338</td>\n","      <td>0.684028</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>31</td>\n","      <td>0.303125</td>\n","      <td>1.610853</td>\n","      <td>0.677083</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>32</td>\n","      <td>0.323611</td>\n","      <td>1.387890</td>\n","      <td>0.722222</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>33</td>\n","      <td>0.303668</td>\n","      <td>1.480481</td>\n","      <td>0.729167</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>34</td>\n","      <td>0.259011</td>\n","      <td>1.547293</td>\n","      <td>0.701389</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>35</td>\n","      <td>0.252786</td>\n","      <td>1.499056</td>\n","      <td>0.725694</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>36</td>\n","      <td>0.249858</td>\n","      <td>1.464229</td>\n","      <td>0.722222</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>37</td>\n","      <td>0.272512</td>\n","      <td>1.583919</td>\n","      <td>0.680556</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>38</td>\n","      <td>0.260785</td>\n","      <td>1.328046</td>\n","      <td>0.743056</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>39</td>\n","      <td>0.232476</td>\n","      <td>1.466082</td>\n","      <td>0.711806</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>40</td>\n","      <td>0.232837</td>\n","      <td>1.413235</td>\n","      <td>0.729167</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>41</td>\n","      <td>0.211371</td>\n","      <td>1.555830</td>\n","      <td>0.697917</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>42</td>\n","      <td>0.224465</td>\n","      <td>1.533228</td>\n","      <td>0.736111</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>43</td>\n","      <td>0.228017</td>\n","      <td>1.484556</td>\n","      <td>0.722222</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>44</td>\n","      <td>0.204462</td>\n","      <td>1.666610</td>\n","      <td>0.697917</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>45</td>\n","      <td>0.200704</td>\n","      <td>1.506540</td>\n","      <td>0.704861</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>46</td>\n","      <td>0.203828</td>\n","      <td>1.597903</td>\n","      <td>0.701389</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>47</td>\n","      <td>0.207503</td>\n","      <td>1.605458</td>\n","      <td>0.697917</td>\n","      <td>01:24</td>\n","    </tr>\n","    <tr>\n","      <td>48</td>\n","      <td>0.203708</td>\n","      <td>1.464317</td>\n","      <td>0.732639</td>\n","      <td>01:24</td>\n","    </tr>\n","    <tr>\n","      <td>49</td>\n","      <td>0.179163</td>\n","      <td>1.601922</td>\n","      <td>0.701389</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>50</td>\n","      <td>0.173239</td>\n","      <td>1.465578</td>\n","      <td>0.708333</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>51</td>\n","      <td>0.184852</td>\n","      <td>1.427202</td>\n","      <td>0.708333</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>52</td>\n","      <td>0.169172</td>\n","      <td>1.481915</td>\n","      <td>0.704861</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>53</td>\n","      <td>0.183357</td>\n","      <td>1.544481</td>\n","      <td>0.715278</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>54</td>\n","      <td>0.185319</td>\n","      <td>1.550339</td>\n","      <td>0.708333</td>\n","      <td>01:24</td>\n","    </tr>\n","    <tr>\n","      <td>55</td>\n","      <td>0.167473</td>\n","      <td>1.514071</td>\n","      <td>0.711806</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>56</td>\n","      <td>0.154672</td>\n","      <td>1.487335</td>\n","      <td>0.715278</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>57</td>\n","      <td>0.140762</td>\n","      <td>1.493149</td>\n","      <td>0.711806</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>58</td>\n","      <td>0.141901</td>\n","      <td>1.458000</td>\n","      <td>0.708333</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>59</td>\n","      <td>0.121269</td>\n","      <td>1.465124</td>\n","      <td>0.704861</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>60</td>\n","      <td>0.105552</td>\n","      <td>1.498801</td>\n","      <td>0.708333</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>61</td>\n","      <td>0.108690</td>\n","      <td>1.507130</td>\n","      <td>0.715278</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>62</td>\n","      <td>0.115085</td>\n","      <td>1.576080</td>\n","      <td>0.701389</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>63</td>\n","      <td>0.138049</td>\n","      <td>1.474285</td>\n","      <td>0.718750</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>64</td>\n","      <td>0.104739</td>\n","      <td>1.532932</td>\n","      <td>0.694444</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>65</td>\n","      <td>0.119962</td>\n","      <td>1.474876</td>\n","      <td>0.718750</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>66</td>\n","      <td>0.110318</td>\n","      <td>1.441162</td>\n","      <td>0.725694</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>67</td>\n","      <td>0.111432</td>\n","      <td>1.405211</td>\n","      <td>0.732639</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>68</td>\n","      <td>0.088230</td>\n","      <td>1.436475</td>\n","      <td>0.725694</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>69</td>\n","      <td>0.082103</td>\n","      <td>1.445056</td>\n","      <td>0.718750</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>70</td>\n","      <td>0.087757</td>\n","      <td>1.503566</td>\n","      <td>0.718750</td>\n","      <td>01:25</td>\n","    </tr>\n","    <tr>\n","      <td>71</td>\n","      <td>0.097327</td>\n","      <td>1.493598</td>\n","      <td>0.708333</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>72</td>\n","      <td>0.097440</td>\n","      <td>1.479770</td>\n","      <td>0.708333</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>73</td>\n","      <td>0.083592</td>\n","      <td>1.503882</td>\n","      <td>0.708333</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>74</td>\n","      <td>0.076437</td>\n","      <td>1.440450</td>\n","      <td>0.718750</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>75</td>\n","      <td>0.078687</td>\n","      <td>1.466238</td>\n","      <td>0.715278</td>\n","      <td>01:28</td>\n","    </tr>\n","    <tr>\n","      <td>76</td>\n","      <td>0.068288</td>\n","      <td>1.428030</td>\n","      <td>0.722222</td>\n","      <td>01:27</td>\n","    </tr>\n","    <tr>\n","      <td>77</td>\n","      <td>0.078191</td>\n","      <td>1.480793</td>\n","      <td>0.718750</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>78</td>\n","      <td>0.080361</td>\n","      <td>1.462096</td>\n","      <td>0.722222</td>\n","      <td>01:26</td>\n","    </tr>\n","    <tr>\n","      <td>79</td>\n","      <td>0.073007</td>\n","      <td>1.455221</td>\n","      <td>0.715278</td>\n","      <td>01:27</td>\n","    </tr>\n","  </tbody>\n","</table>"],"text/plain":["<IPython.core.display.HTML object>"]},"metadata":{"tags":[]}},{"output_type":"stream","text":["Better model found at epoch 0 with accuracy value: 0.3680555522441864.\n","Better model found at epoch 1 with accuracy value: 0.6180555820465088.\n","Better model found at epoch 2 with accuracy value: 0.6701388955116272.\n","Better model found at epoch 3 with accuracy value: 0.7152777910232544.\n","Better model found at epoch 5 with accuracy value: 0.7222222089767456.\n","Better model found at epoch 7 with accuracy value: 0.7326388955116272.\n","Better model found at epoch 38 with accuracy value: 0.7430555820465088.\n","Training completed\n"],"name":"stdout"}]}]}